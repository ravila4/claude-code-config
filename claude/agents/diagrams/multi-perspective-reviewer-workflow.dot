digraph MultiPerspectiveReviewer {
    rankdir = TB;
    compound = true;
    newrank = true;

    // Title
    labelloc = "t";
    label = "Multi-Perspective Reviewer Workflow\nOrchestrates internal agents + external LLMs for comprehensive code/architecture review";
    fontsize = 16;
    fontname = "Arial Bold";

    // Node defaults
    node [fontname="Arial", fontsize=11, style="rounded,filled"];
    edge [fontname="Arial", fontsize=10];

    // Entry point
    Start [label="Review Request\n(files/components)", shape=doublecircle, fillcolor=lightgreen, fontsize=12];

    // Step 1: Check cache
    CheckCache [label="Check cache for\nrecent reviews\n(<24h)?", shape=diamond, fillcolor=yellow];

    UseCache [label="Reuse cached\nexternal LLM responses", shape=box, fillcolor=lightblue];

    // Step 2: Launch internal reviews (parallel)
    subgraph cluster_internal {
        label = "Step 1: Launch Internal Reviews (Parallel)";
        style = filled;
        fillcolor = "#e6f3ff";
        fontsize = 12;
        fontname = "Arial Bold";

        LaunchInternal [label="Launch internal\nagent reviews", shape=box, fillcolor=lightblue];

        PythonReviewer [label="python-code-reviewer\nCode quality, style,\nmaintainability", shape=box, fillcolor="#90EE90"];

        ArchReviewer [label="architecture-devils-advocate\nDesign critique,\nalternatives", shape=box, fillcolor="#90EE90"];
    }

    // Step 3: Consult external LLMs (parallel)
    subgraph cluster_external {
        label = "Step 2: Gather External Perspectives (Parallel)";
        style = filled;
        fillcolor = "#fff4e6";
        fontsize = 12;
        fontname = "Arial Bold";

        LaunchExternal [label="Consult external LLMs\n(with file references)", shape=box, fillcolor=lightblue];

        GeminiConsult [label="gemini-consultant\nGoogle perspective\n(24h cache)", shape=box, fillcolor="#FFD700"];

        GPT5Consult [label="gpt5-consultant\nOpenAI perspective\n(24h cache)", shape=box, fillcolor="#FFD700"];

        CodexConsult [label="codex-consultant\nCode suggestions\n(24h cache)", shape=box, fillcolor="#FFD700"];
    }

    // Collect results
    CollectResults [label="Collect all\nperspectives", shape=box, fillcolor=lightblue];

    // Step 4: Synthesis
    subgraph cluster_synthesis {
        label = "Step 3: Synthesize Results";
        style = filled;
        fillcolor = "#f0e6ff";
        fontsize = 12;
        fontname = "Arial Bold";

        Analyze [label="Analyze findings:\n• Consensus (4+ reviewers)\n• Majority (2-3 reviewers)\n• Divergent opinions\n• Unique insights", shape=box, fillcolor=lightcyan];

        Prioritize [label="Prioritize by:\n• Impact\n• Actionability\n• Effort", shape=box, fillcolor=lightcyan];

        Document [label="Document divergence:\n• Why did they disagree?\n• Which is right for context?\n• Learnings about reviewers", shape=box, fillcolor=lightcyan];
    }

    // Output
    GenerateReport [label="Generate unified report:\n• Critical issues (consensus)\n• Important issues (majority)\n• Divergent opinions\n• Positive findings\n• Prioritized actions", shape=box, fillcolor=lightblue];

    // Step 5: Cache and store
    subgraph cluster_storage {
        label = "Step 4: Cache Results";
        style = filled;
        fillcolor = "#ffe6e6";
        fontsize = 12;
        fontname = "Arial Bold";

        StoreExternal [label="Cache external reviews\n.memories/external-llm-cache/\n{gemini,gpt5,codex}/", shape=cylinder, fillcolor=lightyellow];

        StoreSynthesis [label="Store synthesis\n.memories/reviews/\nYYYY-MM-DD-multi-perspective-{topic}.json", shape=cylinder, fillcolor=lightyellow];

        UpdateMemory [label="Update memory-keeper:\n• Reviewer strengths/weaknesses\n• Common blind spots\n• Synthesis patterns", shape=cylinder, fillcolor=lightyellow];
    }

    // Exit
    End [label="Return concise\nsummary to user\n(<1000 lines)", shape=doublecircle, fillcolor=lightgreen, fontsize=12];

    // Important constraints
    ParallelConstraint [label="MUST: Launch internal\nand external reviews\nIN PARALLEL", shape=octagon, fillcolor=red, fontcolor=white];

    CacheConstraint [label="MUST: Check cache\nbefore external LLM calls\n(avoid redundant API calls)", shape=octagon, fillcolor=red, fontcolor=white];

    // Learning mode trigger
    LearningTrigger [label="Confidence < 0.7?\n(unclear which\nperspective to trust)", shape=diamond, fillcolor=yellow];

    EnterLearning [label="Enter learning mode:\nAsk user for guidance\non divergent opinions", shape=box, fillcolor=orange];

    // Flow
    Start -> CheckCache;

    CheckCache -> UseCache [label="yes\n(cache hit)"];
    CheckCache -> LaunchInternal [label="no\n(cache miss)"];

    UseCache -> LaunchInternal [label="reuse for\nexternal LLMs"];

    // Internal reviews (parallel)
    LaunchInternal -> PythonReviewer [style=bold];
    LaunchInternal -> ArchReviewer [style=bold];

    // External consultations (parallel)
    LaunchInternal -> LaunchExternal [style=dotted, label="parallel"];

    LaunchExternal -> GeminiConsult [style=bold];
    LaunchExternal -> GPT5Consult [style=bold];
    LaunchExternal -> CodexConsult [style=bold];

    // Collect from all sources
    PythonReviewer -> CollectResults;
    ArchReviewer -> CollectResults;
    GeminiConsult -> CollectResults;
    GPT5Consult -> CollectResults;
    CodexConsult -> CollectResults;

    // Synthesis pipeline
    CollectResults -> Analyze;
    Analyze -> Prioritize;
    Prioritize -> Document;

    Document -> LearningTrigger;

    LearningTrigger -> EnterLearning [label="yes"];
    LearningTrigger -> GenerateReport [label="no"];

    EnterLearning -> GenerateReport [label="user provides\nguidance"];

    // Storage
    GenerateReport -> StoreExternal;
    GenerateReport -> StoreSynthesis;
    GenerateReport -> UpdateMemory;

    StoreExternal -> End;
    StoreSynthesis -> End;
    UpdateMemory -> End;

    // Constraints positioning
    ParallelConstraint -> LaunchInternal [style=dashed, color=red, constraint=false];
    CacheConstraint -> CheckCache [style=dashed, color=red, constraint=false];

    // Keep steps at same rank
    { rank=same; LaunchInternal; LaunchExternal; }
    { rank=same; PythonReviewer; ArchReviewer; GeminiConsult; GPT5Consult; CodexConsult; }
    { rank=same; StoreExternal; StoreSynthesis; UpdateMemory; }
}
