#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = [
#   "kokoro-onnx",
#   "soundfile",
# ]
# ///

"""
kokoro-speak - TTS utility using Kokoro ONNX

Usage:
    kokoro-speak "Hello world"
    kokoro-speak "Hello world" --voice af_sarah
    kokoro-speak "Hello world" -v am_adam --speed 1.2
    echo "Hello world" | kokoro-speak
"""

import sys
import io
import subprocess
import argparse
from pathlib import Path
from urllib.request import urlretrieve

import soundfile as sf
from kokoro_onnx import Kokoro


# Default model directory
MODEL_DIR = Path.home() / ".local/share/kokoro-onnx"
MODEL_FILE = MODEL_DIR / "kokoro-v1.0.onnx"
VOICES_FILE = MODEL_DIR / "voices-v1.0.bin"

# Download URLs
MODEL_URL = "https://github.com/thewh1teagle/kokoro-onnx/releases/download/model-files-v1.0/kokoro-v1.0.onnx"
VOICES_URL = "https://github.com/thewh1teagle/kokoro-onnx/releases/download/model-files-v1.0/voices-v1.0.bin"

DEFAULT_VOICE = "am_echo"
DEFAULT_SPEED = 1.0
DEFAULT_LANG = "en-us"


def download_file(url, dest, desc):
    """Download a file with progress indication"""
    print(f"Downloading {desc}...", file=sys.stderr)
    print(f"  From: {url}", file=sys.stderr)
    print(f"  To: {dest}", file=sys.stderr)

    def report_progress(block_num, block_size, total_size):
        downloaded = block_num * block_size
        if total_size > 0:
            percent = min(100, downloaded * 100 / total_size)
            mb_downloaded = downloaded / (1024 * 1024)
            mb_total = total_size / (1024 * 1024)
            print(f"\r  Progress: {percent:.1f}% ({mb_downloaded:.1f}/{mb_total:.1f} MB)",
                  end='', file=sys.stderr)

    try:
        urlretrieve(url, dest, reporthook=report_progress)
        print(file=sys.stderr)  # New line after progress
        print(f"✓ Downloaded {desc}", file=sys.stderr)
    except Exception as e:
        print(f"\n✗ Failed to download {desc}: {e}", file=sys.stderr)
        raise


def ensure_models():
    """Ensure models are downloaded, download if necessary"""
    if MODEL_FILE.exists() and VOICES_FILE.exists():
        return str(MODEL_FILE), str(VOICES_FILE)

    # Models don't exist, download them
    print("=" * 60, file=sys.stderr)
    print("Kokoro models not found. Downloading (~340 MB)...", file=sys.stderr)
    print("=" * 60, file=sys.stderr)

    MODEL_DIR.mkdir(parents=True, exist_ok=True)

    if not MODEL_FILE.exists():
        download_file(MODEL_URL, MODEL_FILE, "kokoro-v1.0.onnx")

    if not VOICES_FILE.exists():
        download_file(VOICES_URL, VOICES_FILE, "voices-v1.0.bin")

    print("=" * 60, file=sys.stderr)
    print(f"✓ Models installed to {MODEL_DIR}", file=sys.stderr)
    print("=" * 60, file=sys.stderr)

    return str(MODEL_FILE), str(VOICES_FILE)


def speak(text, voice, speed, lang, model_path, voices_path):
    """Generate and play speech"""
    kokoro = Kokoro(model_path, voices_path)

    # Generate audio
    samples, sample_rate = kokoro.create(text, voice=voice, speed=speed, lang=lang)

    # Write to buffer
    buffer = io.BytesIO()
    sf.write(buffer, samples, sample_rate, format='WAV')
    buffer.seek(0)

    # Play via ffplay
    proc = subprocess.Popen(
        ['ffplay', '-nodisp', '-autoexit', '-f', 'wav', '-i', 'pipe:0'],
        stdin=subprocess.PIPE,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL
    )
    proc.communicate(input=buffer.read())


def main():
    parser = argparse.ArgumentParser(
        description='Text-to-speech using Kokoro ONNX',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  kokoro-speak "Hello world"
  kokoro-speak "Hello world" --voice am_adam
  kokoro-speak "Hello world" -v af_nova --speed 1.2
  echo "This is a test" | kokoro-speak

Popular voices:
  American female: af_sarah, af_river, af_bella
  American male: am_echo, am_puck, am_liam
  British female: bf_alice, bf_emma
  British male: bm_fable, bm_daniel
        """
    )

    parser.add_argument(
        'text',
        nargs='?',
        help='Text to speak (reads from stdin if not provided)'
    )
    parser.add_argument(
        '-v', '--voice',
        default=DEFAULT_VOICE,
        help=f'Voice to use (default: {DEFAULT_VOICE})'
    )
    parser.add_argument(
        '-s', '--speed',
        type=float,
        default=DEFAULT_SPEED,
        help=f'Speech speed (default: {DEFAULT_SPEED})'
    )
    parser.add_argument(
        '-l', '--lang',
        default=DEFAULT_LANG,
        help=f'Language code (default: {DEFAULT_LANG})'
    )
    parser.add_argument(
        '--model-path',
        help='Path to kokoro-v1.0.onnx (auto-detected if not provided)'
    )
    parser.add_argument(
        '--voices-path',
        help='Path to voices-v1.0.bin (auto-detected if not provided)'
    )
    parser.add_argument(
        '--list-voices',
        action='store_true',
        help='List all available voices and exit'
    )

    args = parser.parse_args()

    # Get model paths - download if necessary
    if args.model_path and args.voices_path:
        model_path = args.model_path
        voices_path = args.voices_path
    else:
        try:
            model_path, voices_path = ensure_models()
        except Exception as e:
            print(f"Error: Failed to ensure models are available: {e}", file=sys.stderr)
            sys.exit(1)

    # List voices if requested
    if args.list_voices:
        kokoro = Kokoro(model_path, voices_path)
        voices = kokoro.get_voices()

        # Group by category
        categories = {
            'American Female': [v for v in voices if v.startswith('af_')],
            'American Male': [v for v in voices if v.startswith('am_')],
            'British Female': [v for v in voices if v.startswith('bf_')],
            'British Male': [v for v in voices if v.startswith('bm_')],
            'Other': [v for v in voices if not v.startswith(('af_', 'am_', 'bf_', 'bm_'))]
        }

        for category, category_voices in categories.items():
            if category_voices:
                print(f"\n{category}:")
                for voice in sorted(category_voices):
                    print(f"  {voice}")
        sys.exit(0)

    # Get text from args or stdin
    if args.text:
        text = args.text
    else:
        if sys.stdin.isatty():
            print("Error: No text provided. Use as argument or pipe from stdin.", file=sys.stderr)
            print("Try: kokoro-speak --help", file=sys.stderr)
            sys.exit(1)
        text = sys.stdin.read().strip()

    if not text:
        print("Error: Empty text provided.", file=sys.stderr)
        sys.exit(1)

    # Speak
    try:
        speak(text, args.voice, args.speed, args.lang, model_path, voices_path)
    except KeyboardInterrupt:
        print("\nInterrupted.", file=sys.stderr)
        sys.exit(130)
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
